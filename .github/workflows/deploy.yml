name: Deploy - NimbusDocs

on:
    push:
        branches: [main]
    workflow_dispatch:

concurrency:
    group: deploy-prod
    cancel-in-progress: false

jobs:
    validate:
        uses: ./.github/workflows/ci.yml

    deploy-production:
        needs: validate
        runs-on: ubuntu-latest
        environment:
            name: production
            url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  tools: composer:v2

            - name: Install Dependencies (Production)
              run: composer install --no-dev --optimize-autoloader --no-progress --prefer-dist

            - name: Create Zip Package
              run: zip -r release.zip . -x ".git/*" ".github/*" "tests/*" "phpunit.xml" "phpstan.neon" ".env*"

            - name: Deploy to Azure Web App
              id: deploy-to-webapp
              uses: azure/webapps-deploy@v2
              with:
                  app-name: "nimbusdocs-prod" # Replace with your app name if different
                  publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
                  package: release.zip

            # Post-deploy check
            - name: Verify Health Endpoint
              run: |
                  # Give it a moment to restart
                  sleep 10
                  echo "Checking health endpoint..."
                  # curl -f https://nimbusdocs-prod.azurewebsites.net/health.php || echo "Health check failed or app starting up"
